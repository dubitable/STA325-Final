---
title: "explore"
output: pdf_document
---

```{r}
library(MASS)
library(e1071)
library(car)
library(caret)
library(pROC)
library(tidymodels)
library(themis)

source("cleandata.R")
source("confusionmatrix.R")
```

```{r}
diabetes_raw <- read.csv("data/diabetes_012_health_indicators_BRFSS2015.csv")
diabetes <- cleandata(diabetes_raw)
head(diabetes)
```

```{r}
diabetes |> count(Diabetes_012)
```

```{r}
rec <- recipe(Diabetes_012 ~ ., data = diabetes) |>
  step_downsample(Diabetes_012)

rec_prep <- prep(rec)

train <- bake(rec_prep, new_data = NULL)

train |> count(Diabetes_012)
```

```{r}
model_polr <- polr(
  Diabetes_012 ~ .^2,
  data = train,
  Hess = TRUE,
)
```

```{r}
coefs <- coef(summary(model_polr))
pvals <- pnorm(abs(coefs[, "t value"]), lower.tail = FALSE) * 2
summary <- cbind(coefs, "p value" = pvals)
```

```{r}
pred <- predict(model_polr, newdata = diabetes, type = "probs")

roc_no <- roc(response = ifelse(diabetes$Diabetes_012 == "NoDiabetes", 1, 0),
              predictor = pred[, "NoDiabetes"],
              quiet = TRUE)

roc_pre <- roc(response = ifelse(diabetes$Diabetes_012 == "PreDiabetes", 1, 0),
               predictor = pred[, "PreDiabetes"],
               quiet = TRUE)

roc_dia <- roc(response = ifelse(diabetes$Diabetes_012 == "Diabetes", 1, 0),
               predictor = pred[, "Diabetes"],
               quiet = TRUE)

plot(roc_no, col = "blue", main = "One-vs-rest ROC Curves", legacy.axes = TRUE)
plot(roc_pre, col = "orange", add = TRUE)
plot(roc_dia, col = "red", add = TRUE)
legend("bottomright",
       legend = c("NoDiabetes", "PreDiabetes", "Diabetes"),
       col = c("blue", "orange", "red"),
       lwd = 2)

auc(roc_no); auc(roc_pre); auc(roc_dia)
```

```{r}
target <- 0.9
avail <- roc_pre$sensitivities
closest <- avail[which.min(abs(avail - target))]
coords(roc_pre, x = closest, input = "sensitivity", ret = c("threshold", "specificity", "sensitivity"))
```

```{r}
pred <- predict(model_polr, newdata = diabetes, type = "probs")
pred_df <- as.data.frame(pred)

t_pre <- 0.5
t_diab <- 0.3

cm <- create_cm(pred_df, t_pre, t_diab, diabetes)
plot_cm(cm)
```

