---
title: "explore"
output: pdf_document
---

```{r}
set.seed(123)

library(MASS)
library(caret)
library(pROC)
library(brant)

source("cleandata.R")
source("confusionmatrix.R")
source("partition.R")
source("eval.R")
```

```{r}
diabetes_raw <- read.csv("data/diabetes_012_health_indicators_BRFSS2015.csv")
diabetes <- cleandata(diabetes_raw)
head(diabetes)
```

```{r}


diabetes |> count(Diabetes_012) |> ggplot(aes(x = "", y = n, fill=Diabetes_012)) + 
  geom_bar(stat="identity", width=1) +
  coord_polar("y", start=0) + 
  theme_void() + 
  labs(fill = "Diabetes Status")
```

```{r}
split <- partition(diabetes, 0.8)
train <- split$train
test <- split$test

train |> count(Diabetes_012)
```

```{r}
model_polr <- polr(
  Diabetes_012 ~ HighBP + HighChol + CholCheck + BMI + HeartDiseaseorAttack + HvyAlcoholConsump + GenHlth + Sex + Age + HighBP:GenHlth,
  data = train,
  Hess = TRUE,
)
```

```{r}
#n <- nrow(train)
#model_polr_stepBIC <- stepAIC(
#  model_polr,
#  direction = "both",
#  scope = list(lower = ~1, upper = ~ .^2),
#  k = log(n)
#)
```

```{r}
#model_polr <- model_polr_stepBIC
summary(model_polr)
```

```{r}
pvalues <- function (model, threshold = 0.05) {
  coefs <- as.data.frame(coef(summary(model_polr)))
  pvals <- pnorm(abs(coefs[, "t value"]), lower.tail = FALSE) * 2
  significant <- if_else(pvals < threshold, "*", "")
  summary <- cbind(coefs, "p value" = pvals, "sig" = significant)
  return(summary)
}
```

```{r}
pvalues(model_polr, 0.01)
```

```{r}
pred <- predict(model_polr, newdata = test, type = "probs")

roc_no <- roc(response = ifelse(test$Diabetes_012 == "NoDiabetes", 1, 0),
              predictor = pred[, "NoDiabetes"],
              quiet = TRUE)

roc_pre <- roc(response = ifelse(test$Diabetes_012 == "PreDiabetes", 1, 0),
               predictor = pred[, "PreDiabetes"],
               quiet = TRUE)

roc_dia <- roc(response = ifelse(test$Diabetes_012 == "Diabetes", 1, 0),
               predictor = pred[, "Diabetes"],
               quiet = TRUE)

plot(roc_no, col = "blue", main = "One-vs-rest ROC Curves", legacy.axes = TRUE)
plot(roc_pre, col = "orange", add = TRUE)
plot(roc_dia, col = "red", add = TRUE)
legend("bottomright",
       legend = c("NoDiabetes", "PreDiabetes", "Diabetes"),
       col = c("blue", "orange", "red"),
       lwd = 2)

auc(roc_no); auc(roc_pre); auc(roc_dia)
```

```{r}
target <- 0.7
avail <- roc_pre$sensitivities
closest <- avail[which.min(abs(avail - target))]
coords(roc_pre, x = closest, input = "sensitivity", ret = c("threshold", "specificity", "sensitivity"))
```

```{r}
pred <- predict(model_polr, newdata = test, type = "probs")
predclass <- predict(model_polr, newdata = test, type = "class")
pred_df <- as.data.frame(pred)

t_pre <- 0.5
t_diab <- 0.3

cm <- create_cm(pred_df, t_pre, t_diab, test)
cm$table
plot_cm(cm)
```

```{r}
qwk_score(predclass, test$Diabetes_012)
mae_ord(pred, test$Diabetes_012)
```


```{r}
plot_probs <- function(model, inputs) {
  a1 <- model$zeta["NoDiabetes|PreDiabetes"]
  a2 <- model$zeta["PreDiabetes|Diabetes"]
  
  coefs <- model$coefficients
  
  offset <- 0
  
  if (!is.null(inputs)) {
    names_in_model <- intersect(names(inputs), names(coefs))
    offset <- sum(coefs[names_in_model] * unlist(inputs[names_in_model]))
  }
  
  b <-  coefs["BMI"]
  
  x <- seq(min(diabetes$BMI), max(diabetes$BMI), by = 0.1)
  
  eta1 <- a1 - (b * x + offset)
  eta2 <- a2 - (b * x + offset)
  
  P1 <- plogis(eta1)
  P2 <- plogis(eta2)
  
  p1 <- P1
  p2 <- P2 - P1
  p3 <- 1 - P2
  
  df <- data.frame(
    x = rep(x, 3),
    prob = c(p1, p2, p3),
    outcome = factor(rep(c("NoDiabetes", "PreDiabetes", "Diabetes"), each = length(x)))
  )
  
  ggplot(df, aes(x = x, y = prob, color = outcome)) +
    geom_line() +
    ylab("Probability") +
    xlab("BMI") +
    theme_minimal() 
}
```

```{r}
inputs <- list(
  HighBP = 1,
  HighChol = 1,
  CholCheck = 1,
  HeartDiseaseorAttack = 1,
  HvyAlcoholConsump = 1,
  GenHlth = 5,
  Sex = 1,
  Age = 10
)

plot_probs(model_polr, inputs)
```

