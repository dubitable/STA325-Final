---
title: "explore"
output: pdf_document
---

```{r}
library(MASS)
library(e1071)
library(car)
library(caret)
library(pROC)
library(brant)

source("cleandata.R")
source("confusionmatrix.R")
source("partition.R")
```

```{r}
diabetes_raw <- read.csv("data/diabetes_012_health_indicators_BRFSS2015.csv")
diabetes <- cleandata(diabetes_raw)
head(diabetes)
```

```{r}
diabetes |> count(Diabetes_012)
```

```{r}
split <- partition(diabetes, 0.8)
train <- split$train
test <- split$test

train |> count(Diabetes_012)
```

```{r}
model_polr <- polr(
  Diabetes_012 ~ .,
  data = train,
  Hess = TRUE,
)
```

```{r}
n <- nrow(train)
model_polr_stepBIC <- stepAIC(
  model_polr,
  direction = "both",
  k = log(n)
)
```

```{r}
model_polr <- model_polr_step
```

```{r}
pvalues <- function (model, threshold = 0.05) {
  coefs <- as.data.frame(coef(summary(model_polr)))
  pvals <- pnorm(abs(coefs[, "t value"]), lower.tail = FALSE) * 2
  significant <- if_else(pvals < threshold, "*", "")
  summary <- cbind(coefs, "p value" = pvals, "sig" = significant)
  return(summary)
}
```

```{r}
pvalues(model_polr, 0.01)
```

```{r}
pred <- predict(model_polr, newdata = test, type = "probs")

roc_no <- roc(response = ifelse(test$Diabetes_012 == "NoDiabetes", 1, 0),
              predictor = pred[, "NoDiabetes"],
              quiet = TRUE)

roc_pre <- roc(response = ifelse(test$Diabetes_012 == "PreDiabetes", 1, 0),
               predictor = pred[, "PreDiabetes"],
               quiet = TRUE)

roc_dia <- roc(response = ifelse(test$Diabetes_012 == "Diabetes", 1, 0),
               predictor = pred[, "Diabetes"],
               quiet = TRUE)

plot(roc_no, col = "blue", main = "One-vs-rest ROC Curves", legacy.axes = TRUE)
plot(roc_pre, col = "orange", add = TRUE)
plot(roc_dia, col = "red", add = TRUE)
legend("bottomright",
       legend = c("NoDiabetes", "PreDiabetes", "Diabetes"),
       col = c("blue", "orange", "red"),
       lwd = 2)

auc(roc_no); auc(roc_pre); auc(roc_dia)
```

```{r}
target <- 0.7
avail <- roc_pre$sensitivities
closest <- avail[which.min(abs(avail - target))]
coords(roc_pre, x = closest, input = "sensitivity", ret = c("threshold", "specificity", "sensitivity"))
```

```{r}
pred <- predict(model_polr, newdata = test, type = "probs")
pred_df <- as.data.frame(pred)

t_pre <- 0.5
t_diab <- 0.3

cm <- create_cm(pred_df, t_pre, t_diab, test)
plot_cm(cm)
```

```{r}
brant(model_polr)
```
